#!/usr/bin/env bash

# Copyright (c) XJ Music Inc. (https://xj.io) All Rights Reserved.

# Include common functions
. $( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )/../../common/functions

# Requires 6 arguments
if [ $# != 6 ]; then echo "
   Usage:
     bin/sql/backup/schema <user> <password> <database> <host> <port> <path/to/output.sql>

"
fi
SQL_USER="${1}"
SQL_DB="${3}"
SQL_HOST="${4}"
SQL_PORT="${5}"
OUTPUT_SQL="${6}"
export PGPASSWORD=postgres

# Tables
SCHEMA_VERSION_TABLE="xj.flyway_schema_history"
COPYRIGHT="Copyright (c) XJ Music Inc. (https://xj.io) All Rights Reserved."

# empty target file
printf "\-\- ${COPYRIGHT}\n\n" > ${OUTPUT_SQL}

# first export only the schema
pg_dump -C -s \
  --username=${SQL_USER} \
  --host=${SQL_HOST} \
  --port=${SQL_PORT} \
  --dbname=${SQL_DB} >> ${OUTPUT_SQL}

# then append data from only the schema version table
pg_dump -a \
  --username=${SQL_USER} \
  --host=${SQL_HOST} \
  --port=${SQL_PORT} \
  --table=${SCHEMA_VERSION_TABLE} \
  --dbname=${SQL_DB} >> ${OUTPUT_SQL}
