#!/usr/bin/env bash

# Include common functions
. $( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )/../common/functions

# Title & Usage
COPYRIGHT="Copyright (c) 2018, XJ Music Inc. (https://xj.io) All Rights Reserved."
TITLE="Dump reset_database.sql to MySQL db"
USAGE="
   Usage:
     bin/mysql/dump_for_reset <host> <arguments...>

   <host> to run, as in: mysql -h <host>
   <arguments...> (optional) passed to 'mysql' client
"

# Connect as root
MYSQL_USER="root"
MYSQL_PORT=3300
MYSQL_TABLES="account account_user audio audio_chord audio_event instrument instrument_meme library sequence sequence_meme pattern pattern_chord pattern_meme pattern_event schema_version user user_role voice"
MYSQL_TEST_TABLES="schema_version"

# Find MySQL executable
MYSQLDUMP_COMMAND=mysqldump
if [ -f /usr/bin/mysqldump ]; then
    MYSQLDUMP_COMMAND=/usr/bin/mysqldump
elif [ -f /usr/local/mysql/bin/mysqldump ]; then
    MYSQLDUMP_COMMAND=/usr/local/mysql/bin/mysqldump
fi

# Host Arguments
MYSQL_ARGS="${@}"

# Database
MYSQL_TEST_DB="xj_test"
MYSQL_DB="xj"

# Expected Example MySQL database
EXAMPLE_SQL=${PWD}/reset_database.sql

step "Client SQL execution"
# empty target file
printf "# ${COPYRIGHT}\n\n" > ${EXAMPLE_SQL}
# first structure of all tables, including test db
${MYSQLDUMP_COMMAND} --no-data -u${MYSQL_USER} -h 127.0.0.1 -P ${MYSQL_PORT} ${MYSQL_ARGS} --databases ${MYSQL_DB} ${MYSQL_TEST_DB} >> ${EXAMPLE_SQL}
# blank spaces

# then append data from only certain tables
for i in $(seq 1 20); do echo "" >> ${EXAMPLE_SQL}; done
printf "#-------------\nUSE \`${MYSQL_DB}\`;\n\n" >> ${EXAMPLE_SQL}
${MYSQLDUMP_COMMAND} --no-create-info -u${MYSQL_USER} -h 127.0.0.1 -P ${MYSQL_PORT} ${MYSQL_ARGS} --databases ${MYSQL_DB} --tables ${MYSQL_TABLES} >> ${EXAMPLE_SQL}
# and test tables
for i in $(seq 1 20); do echo "" >> ${EXAMPLE_SQL}; done
printf "#-------------\nUSE \`${MYSQL_TEST_DB}\`;\n\n" >> ${EXAMPLE_SQL}
${MYSQLDUMP_COMMAND} --no-create-info -u${MYSQL_USER} -h 127.0.0.1 -P ${MYSQL_PORT} ${MYSQL_ARGS} --databases ${MYSQL_TEST_DB} --tables ${MYSQL_TEST_TABLES} >> ${EXAMPLE_SQL}
step_ok

# ensure platform is packaged
ensure_file ${EXAMPLE_SQL} "Example MySQL database"

#
finished_ok
