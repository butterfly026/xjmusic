#!/usr/bin/env bash

# Include common functions
. $( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )/../common/functions

# Requires 6 arguments
if [ $# != 6 ]; then echo "
   Usage:
     bin/mysql/dump_records <user> <password> <database> <host> <port> <path/to/output.sql>

"
fi
MYSQL_USER="${1}"
MYSQL_PASS="${2}"
MYSQL_DB="${3}"
MYSQL_HOST="${4}"
MYSQL_PORT="${5}"
OUTPUT_SQL="${6}"

# Tables
MYSQL_TABLES="account account_user audio audio_chord audio_event instrument instrument_meme library sequence sequence_meme pattern pattern_chord pattern_meme pattern_event schema_version user user_role voice"

# Copyright
COPYRIGHT="Copyright (c) 2018, XJ Music Inc. (https://xj.io) All Rights Reserved."

# Find MySQL executable
MYSQLDUMP_COMMAND=mysqldump
if [ -f /usr/bin/mysqldump ]; then
    MYSQLDUMP_COMMAND=/usr/bin/mysqldump
elif [ -f /usr/local/mysql/bin/mysqldump ]; then
    MYSQLDUMP_COMMAND=/usr/local/mysql/bin/mysqldump
fi

step "Client SQL execution"
# empty target file
printf "-- ${COPYRIGHT}\n\n" > ${OUTPUT_SQL}

# then append data from only certain tables
for i in $(seq 1 20); do echo "" >> ${OUTPUT_SQL}; done
printf "-- -------------\nUSE \`${MYSQL_DB}\`;\n\n" >> ${OUTPUT_SQL}
${MYSQLDUMP_COMMAND} --no-create-info -u${MYSQL_USER} -p${MYSQL_PASS} -h ${MYSQL_HOST} -P ${MYSQL_PORT} --databases ${MYSQL_DB} --tables ${MYSQL_TABLES} >> ${OUTPUT_SQL}
step_ok

# ensure platform is packaged
ensure_file ${OUTPUT_SQL} "Example MySQL database"

#
finished_ok
