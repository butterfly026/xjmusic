#!/usr/bin/env bash

# Include common functions
. $( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )/../../common/functions

# Requires 6 arguments
if [ $# != 6 ]; then echo "
   Usage:
     bin/mysql/dump_records <user> <password> <database> <host> <port> <path/to/output.sql>

"
fi
MYSQL_USER="${1}"
MYSQL_PASS="${2}"
MYSQL_DB="${3}"
MYSQL_HOST="${4}"
MYSQL_PORT="${5}"
OUTPUT_SQL="${6}"

#
EXCLUDED_TABLES=(
chain
chain_config
chain_instrument
chain_library
chain_sequence
platform_message
schema_version
segment
)

#
IGNORED_TABLES_STRING=''
for TABLE in "${EXCLUDED_TABLES[@]}"
do :
   IGNORE_TABLE=" --ignore-table=${MYSQL_DB}.${TABLE}"
   echo "${IGNORE_TABLE}"
   IGNORED_TABLES_STRING+="${IGNORE_TABLE}"
done

# Tables
COPYRIGHT="Copyright (c) 2018, XJ Music Inc. (https://xj.io) All Rights Reserved."

# Find MySQL executable
MYSQLDUMP_COMMAND=mysqldump
if [ -f /usr/bin/mysqldump ]; then
    MYSQLDUMP_COMMAND=/usr/bin/mysqldump
elif [ -f /usr/local/mysql/bin/mysqldump ]; then
    MYSQLDUMP_COMMAND=/usr/local/mysql/bin/mysqldump
fi

# empty target file
printf "# ${COPYRIGHT}\n\n" > ${OUTPUT_SQL}

# only send password argument if there is a non-null password
if [ -n "${MYSQL_PASS}" ]; then
  MYSQL_PASS_STRING="--password=${MYSQL_PASS}"
else
  MYSQL_PASS_STRING=""
fi

# then append data from only certain tables
${MYSQLDUMP_COMMAND} \
  --no-create-info \
  --user=${MYSQL_USER} \
  --host=${MYSQL_HOST} \
  --port=${MYSQL_PORT} \
  ${MYSQL_PASS_STRING} \
  ${MYSQL_DB} \
  ${IGNORED_TABLES_STRING} >> ${OUTPUT_SQL}

