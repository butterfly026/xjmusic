#!/usr/bin/env bash

# Include common functions
. $( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )/../../common/functions

# Connect as root
MYSQL_USER="root"
MYSQL_PORT=3300
MYSQL_HOST="127.0.0.1"

# Find MySQL executable
MYSQL_COMMAND=mysql
if [ -f /usr/bin/mysql ]; then
    MYSQL_COMMAND=/usr/bin/mysql
elif [ -f /usr/local/mysql/bin/mysql ]; then
    MYSQL_COMMAND=/usr/local/mysql/bin/mysql
fi

# Database
MYSQL_DB_MAIN="xj_production"
MYSQL_DB_TEST="xj_test"

# Reset command SQL
RESET_CMD="
  drop database if exists ${MYSQL_DB_MAIN};
  drop database if exists ${MYSQL_DB_TEST};
  create database ${MYSQL_DB_MAIN};
  create database ${MYSQL_DB_TEST};
  "

# Source
SOURCE_PREFIX="${PWD}/.mysql/dump/"
SOURCE_MAIN_SCHEMA_SQL="${SOURCE_PREFIX}main.schema.sql"
SOURCE_MAIN_RECORDS_SQL="${SOURCE_PREFIX}main.records.sql"
SOURCE_TEST_SCHEMA_SQL="${SOURCE_PREFIX}test.schema.sql"

#
step "Destroy and re-create databases"
${MYSQL_COMMAND} -u${MYSQL_USER} -h ${MYSQL_HOST} -P ${MYSQL_PORT} -e "${RESET_CMD}"
step_ok

#
step "Create main DB schema"
${MYSQL_COMMAND} -u${MYSQL_USER} -h ${MYSQL_HOST} -P ${MYSQL_PORT} ${MYSQL_DB_MAIN} < ${SOURCE_MAIN_SCHEMA_SQL}
step_ok

#
step "Insert main DB records"
${MYSQL_COMMAND} -u${MYSQL_USER} -h ${MYSQL_HOST} -P ${MYSQL_PORT} ${MYSQL_DB_MAIN} < ${SOURCE_MAIN_RECORDS_SQL}
step_ok

#
step "Create test DB schema"
${MYSQL_COMMAND} -u${MYSQL_USER} -h ${MYSQL_HOST} -P ${MYSQL_PORT} ${MYSQL_DB_TEST} < ${SOURCE_TEST_SCHEMA_SQL}
step_ok

#
finished_ok
