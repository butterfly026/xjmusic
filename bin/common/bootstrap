#!/usr/bin/env bash

#   This is the ONLY app bootstrap script. It is shared by both
#   the Docker config and bin/release-elasticbeanstalk vectors
#   which are responsible for its respective implementation.
#
TITLE="App Bootstrap"
USAGE="
   Usage:
     bin/common/bootstrap <app> <arguments...>

   <app> to run, as in: java io.xj.<app>
   <arguments...> (optional) passed to 'java'
"

#
require () {
  VALUE="${1}"
  NAME="${2}"
  if [ "${VALUE}" == "" ]; then
    printf "\nERROR! <${NAME}> is required.\n${USAGE}\n"
    exit 1
  fi
}

#
APP=${1}
require "${APP}" "app"

#
CONFIG_PATH=/var/app/current/env.conf

#
JAR=/var/app/current/target/${APP}-1.0-SNAPSHOT-jar-with-dependencies.jar
if [ ! -e ${JAR} ]; then
  printf "\n\nCan't find ${JAR}!\nPlease package the build artifacts.\n\n"
  exit 1
fi

#
LOG_DIR=/var/log/${APP}
mkdir -p ${LOG_DIR}

#
STDOUT_LOG=${LOG_DIR}/${APP}.out.log
STDERR_LOG=${LOG_DIR}/${APP}.err.log

#
ACCESS_LOG=${LOG_DIR}/${APP}.access.log
touch ${ACCESS_LOG}
chmod +w ${ACCESS_LOG}

#
printf "[$(date)]\n"
printf "Environment:\n"
printenv
printf "Starting java: ${JAR}\n"
printf "   stdout log: ${STDOUT_LOG}\n"
printf "   stderr log: ${STDERR_LOG}\n"
printf "   access log: ${ACCESS_LOG}\n"
java \
  -jar ${JAR} \
  ${CONFIG_PATH} 1> ${STDOUT_LOG} 2> ${STDERR_LOG}
