#!/usr/bin/env bash

#   This is the ONLY app bootstrap script. It is shared by both
#   the Docker config and bin/release-elasticbeanstalk vectors
#   which are responsible for its respective implementation.
#
TITLE="App Bootstrap"
USAGE="
   Usage:
     bin/common/bootstrap <app> <arguments...>

   <app> to run, as in: java io.outright.xj.<app>
   <arguments...> (optional) passed to 'java'
"

#
require () {
  VALUE="${1}"
  NAME="${2}"
  if [ "${VALUE}" == "" ]; then
    printf "\nERROR! <${NAME}> is required.\n${USAGE}\n"
    exit 1
  fi
}

#
APP=${1}
require "${APP}" "app"

#
JAR=/var/app/current/${APP}/target/${APP}-1.0-SNAPSHOT.jar
if [ ! -e ${JAR} ]; then
  printf "\n\nCan't find ${JAR}!\nPlease package the build artifacts.\n\n"
  exit 1
fi

#
LOG_DIR=/var/log/${APP}
mkdir -p ${LOG_DIR}

#
STDOUT_LOG=${LOG_DIR}/${APP}.out.log
STDERR_LOG=${LOG_DIR}/${APP}.err.log
ACCESS_LOG=${LOG_DIR}/access.log
EXTRA_JAVA_ARGS="-Dlog.access.filename=${ACCESS_LOG}"

# Java System Properties
#
# The default system properties are in the file: /default.env
# which is copied to a new file on project setup: /runtime.env
#
# Developers modify the .gitignored file: /runtime.env
# (e.g. to add private keys and test specific configurations)
#
if [ -a ${PWD}/runtime.env ]; then
  printf "Loaded Java Properties from ${PWD}/runtime.env\n\n"
  . ${PWD}/runtime.env
else
  printf "\n\nCan't find ${PWD}/runtime.env!\nPlease create one based on default.env.\n\n"
  exit 1
fi

#
printf "[$(date)]\n"
printf "Starting java: ${JAR}\n"
printf "   stdout log: ${STDOUT_LOG}\n"
printf "   stderr log: ${STDERR_LOG}\n"
printf "   access log: ${ACCESS_LOG}\n"
java ${JAVA_ARGS} ${EXTRA_JAVA_ARGS} -jar ${JAR} 1> ${STDOUT_LOG} 2> ${STDERR_LOG}
