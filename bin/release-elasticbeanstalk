#!/usr/bin/env bash

# Include common functions
. $( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )/common/core

## Require AWS Elastic Beanstalk CLI
#ensure_version "eb --version" "AWS Elastic Beanstalk CLI"

# apps, configs, static assets
APPS="hub craft ship"
STATICS="ui/dist"

# Must not have outstanding git changes
gitcheck ${PWD}

#
DATE="$(date -u +%Y.%m.%d-UTC.%H.%M.%S)"
COMMIT="$(git rev-parse --verify HEAD)"
VERSION="${DATE}-${COMMIT}"
ZIP_FILE=${PWD}/target/xj-release-${VERSION}.zip
#ZIP_FILE=${PWD}/target/xj-release.zip
step "Release ${VERSION}"
indent "${ZIP_FILE}"
step_ok

#
step "Clean target"
rm -fr ${PWD}/target
mkdir ${PWD}/target
step_ok

#
step "Add Procfile to target"
indent "$(cat Procfile)"
cp Procfile ${PWD}/target/Procfile
step_ok

#
step "Add artifacts to target"
for APP in ${APPS}; do
  JAR=${APP}/target/${APP}-1.0-SNAPSHOT.jar
  indent "${JAR}"
  mkdir -p ${PWD}/target/${APP}/target
  cp ${JAR} ${PWD}/target/${JAR}
done
step_ok

#
step "Add nginx locations for Elastic Beanstalk config to target"
mkdir -p ${PWD}/target/.ebextensions/nginx/conf.d/elasticbeanstalk
cp ${PWD}/.nginx/locations.conf \
   ${PWD}/target/.ebextensions/nginx/conf.d/elasticbeanstalk/00_application.conf
step_ok

#
step "Add Tomcat settings for Elastic Beanstalk config to target"
mkdir -p ${PWD}/target/.ebsettings
cp ${PWD}/.elasticbeanstalk/tomcat-settings.config \
   ${PWD}/target/.ebsettings/tomcat-settings.config
step_ok

#
step "Add static content to target"
for DIR in ${STATICS}; do
  indent "${DIR}"
  mkdir -p ${PWD}/target/${DIR}
  cp -fr ${DIR} ${PWD}/target/${DIR}
done
step_ok

#
step "Compress target to ZIP file"
cd ${PWD}/target
FILES=$(ls -a | grep -v '^\.$' | grep -v '^\.\.$')
for FILE in ${FILES}; do
  indent ${FILE}
  zip -r ${ZIP_FILE} ${FILE}
done
step_ok

#
step "Ready to release ZIP file"
unzip -l ${ZIP_FILE}
step_ok

##
#step "Deploy with Elastic Beanstalk"
#RELEASE="xj-release-${VERSION}"
#indent "${RELEASE}"
#eb deploy --label "${RELEASE}"
#step_ok

#
finished_ok
