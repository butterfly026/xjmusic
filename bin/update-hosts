#!/usr/bin/env bash

# Regex to `grep -oE` the IP addresses from `docker ps`
DOCKER_IP_REGEX='"IPAddress": "[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}",'

# Special box
SPECIAL_MATCH=^hub01
SPECIAL_HOST=xj.outright.dev

#
HOSTS_FILE=/etc/hosts

#
add_host() {
    HOST=${1}
    IP=${2}
    # remove the line if it already exists
    if [ -n "$(grep ${HOST} /etc/hosts)" ]
    then
        sed -i".bak" "/$HOST/d" ${HOSTS_FILE}
        printf "removed and re-"
    fi
    # add the line
    ADD_LINE="${IP} ${HOST}"
    echo "${ADD_LINE}" >> ${HOSTS_FILE}
    printf "added ${HOST} at ${IP}\n"
}

# Loop through all docker containers
for HOST in $(docker ps --format '{{.Names}}'); do
    IP=$(docker inspect ${HOST} | grep -oE "${DOCKER_IP_REGEX}" | sed 's/[^0-9\.]//g')
    add_host "${HOST}" "${IP}"
    if [[ ${HOST} =~ ${SPECIAL_MATCH} ]]; then
      add_host "${SPECIAL_HOST}" "${IP}"
    fi
done
echo "${HOSTS_FILE} updated."
