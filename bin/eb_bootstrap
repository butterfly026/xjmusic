#!/usr/bin/env bash

TITLE="Elastic Beanstalk App Pre-Bootstrap (Wraps common bootstrap)"
USAGE="
   Usage:
     bin/eb_bootstrap <arguments...>

   Expects an environment variable APPS
   which is a space-separated list of apps to run.
   For example:

     APPS=\"hub\"
       operates only the Hub frontend

     APPS=\"worker\"
       operates the Worker client

   <arguments...> (optional) passed to 'bin/bootstrap'
"

#
require () {
  VALUE="${1}"
  NAME="${2}"
  if [ "${VALUE}" == "" ]; then
    printf "\nERROR! <${NAME}> is required.\n${USAGE}\n"
    exit 1
  fi
}

#
kill_javas_running () {
  JAR="${1}"
  printf "\nKilling any process currently running Java ${JAR}...\n"
  JAVA_PIDS="$(ps -aef | grep java | grep ${JAR} | grep -oE "^webapp\s+[0-9]+" | grep -oE "[0-9]+")"
  for PID in ${JAVA_PIDS}; do
    printf "\nKilling ${PID}..."
    kill ${PID}
    printf "OK\n"
  done
}


#
echo "mysql --host=${DB_MYSQL_HOST} --port=${DB_MYSQL_PORT} --user=${DB_MYSQL_USER} --password=${DB_MYSQL_PASS}"
echo "redis-cli -h ${DB_REDIS_HOST} -p ${DB_REDIS_PORT}"

# spawn processes
for APP in ${APPS}; do
  require "${APP}" "app"
  kill_javas_running "${APP}-1.0-SNAPSHOT.jar"
  sleep 2
  printf "OK\n\n"

  bin/bootstrap ${APP} ${2} ${3} ${4} ${5} ${6} ${7} ${8} ${9} &
done

# wait for processes
for job in `jobs -p`
do
  echo "Waiting for pid ${job}"
  wait ${job}
done
