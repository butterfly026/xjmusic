# Run all XJ UI components for local development, with build and watch."
#!/usr/bin/env bash

# Include common functions
. $( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )/../common/functions

# Failure routine
fail() {
    MSG=${1}
    printf "\n${RED}FAILURE!${RESET}"
    printf "\n${MSG}"
    printf "\n"
    exit 1
}

# Require NPM based dependency
require_npm() {
    NAME=${1}
    CMD=${2}
    step "Requires ${NAME}"
    ${CMD} || fail "Requires ${NAME}. Please ensure ${NAME} is installed on this machine. Then use 'npm install' to ensure dependencies are installed for this project!"
    step_ok
}

# Require NPM based dependencies
require_npm "Gulp" "gulp -v"
require_npm "Ember" "ember -v"
require_npm "Vue CLI" "vue build --version"

#
step "XJ UI ${GREEN}OK${RESET}"
indent "Will build & watch all UI."
indent "Send quit signal to teardown all processes."
step_ok

# Hub Mk1 UI (start)
step "Build Hub Mk1 UI (Ember)"
cd ${BASEPATH}/ui/web-artist-mk1
npm install || fail "Installing Hub Mk1 UI dependencies via NPM"
ember build --watch &
HUB_EMBER_PID=$!

# Hub Mk2 UI (start)
step "Build Hub Mk2 UI (Vue)"
cd ${BASEPATH}/ui/web-artist-mk2
npm install || fail "Installing Hub Mk2 UI dependencies via NPM"
npm run build-watch &
STEPMATIC_UI_PID=$!

# Player UI (start)
step "Build Player UI"
cd ${BASEPATH}/ui/web-player
npm install || fail "Installing Player UI dependencies via NPM"
gulp watch &
PLAYER_UI_PID=$!

# Loop til quit
while :
do
	sleep 1
done

# Hub UI (stop)
kill ${HUB_EMBER_PID}

# Player UI (stop)
kill ${PLAYER_UI_PID}

# Stepmatic UI (stop)
kill ${STEPMATIC_UI_PID}

#
finished_ok

