#!/usr/bin/env bash

#
mysql_ok () {
  HOST="${1}"
  PORT="${2}"
  if mysql \
    -h "${HOST}" \
    -P "${PORT}" \
    -uroot \
    --connect-timeout=1 \
    -e 'show status;' \
    &> /dev/null; then
    return 0
  else
    return 1
  fi
}
#
mysql_create_database () {
  HOST="${1}"
  PORT="${2}"
  NAME="${3}"
  if mysql \
    -h "${HOST}" \
    -P "${PORT}" \
    -uroot \
    --connect-timeout=1 \
    -e "create database if not exists ${NAME};"; then
    echo "Created MySQL database ${NAME}"
    return 0
  else
    echo "Failed to create MySQL database ${NAME}"
    return 1
  fi
}
#
redis_ok () {
  HOST="${1}"
  PORT="${2}"
  if timeout 1 redis-cli \
    -h "${HOST}" \
    -p "${PORT}" \
    lpush test 1
    &> /dev/null; then
    return 0
  else
    return 1
  fi
}
#
wait_until () {
  CMD="${1}"
  while ! eval "${CMD}"; do
    printf "Waiting for ${CMD}...\n"
    sleep 1
  done
  printf "${CMD}.\n"
}

#
printf "\n[xj:docker]\n"

#
wait_until "mysql_ok mysql01xj1 3306"
wait_until "redis_ok redis01xj1 6379"

#
if ! mysql_create_database mysql01xj1 3306 xj; then
  exit 1
fi

# serve static frontend with nginx
FRONTEND_PATH=/var/app/current/ui/hub/dist/
if [ ! -e "${FRONTEND_PATH}/index.html" ]; then
  printf "Cannot find ${FRONTEND_PATH}/index.html"
  exit 1
fi
chmod -R +r "${FRONTEND_PATH}"
service nginx start

# spawn processes
for APP in ${APPS}; do
  bin/bootstrap ${APP} &
done

# interactive tty
printf "\nLogging in...\n"
/bin/bash
